<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF Viewer with Annotations</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 1rem 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .title {
        color: white;
        font-size: 1.5rem;
        font-weight: 600;
      }

      .controls {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
      }

      .file-input {
        position: absolute;
        left: -9999px;
      }

      .file-label {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.3);
        font-size: 0.9rem;
        font-weight: 500;
      }

      .file-label:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      .nav-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .nav-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .nav-btn:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      .nav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .page-info {
        color: white;
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .zoom-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .zoom-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 0.4rem 0.8rem;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
        font-weight: bold;
      }

      .zoom-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .annotation-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        padding: 0.5rem;
        border-radius: 25px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .tool-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 0.5rem;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1.1rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .tool-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .tool-btn.active {
        background: rgba(255, 255, 255, 0.4);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      }

      .color-palette {
        display: flex;
        gap: 0.3rem;
        align-items: center;
      }

      .color-option {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
      }

      .color-option:hover,
      .color-option.active {
        transform: scale(1.2);
        border-color: white;
      }

      .brush-size {
        display: flex;
        align-items: center;
        gap: 0.3rem;
      }

      .size-slider {
        width: 60px;
        height: 5px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 5px;
        outline: none;
        cursor: pointer;
      }

      .size-slider::-webkit-slider-thumb {
        appearance: none;
        width: 15px;
        height: 15px;
        background: white;
        border-radius: 50%;
        cursor: pointer;
      }

      .main-content {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 2rem;
        overflow: hidden;
      }

      .viewer-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        max-width: 100%;
        max-height: 100%;
        overflow: auto;
        position: relative;
      }

      .pages-container {
        display: block; /* instead of flex */
        justify-content: unset;
        align-items: unset;
        gap: 0; /* no horizontal gap */
      }

      .single-page {
        margin: 0 auto;
      }

      .page-wrapper {
        background: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        border: 2px solid #ddd;
      }

      .page-canvas,
      .annotation-canvas {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
      }

      .page-canvas {
        position: relative;
      }

      .annotation-canvas {
        pointer-events: none;
        position: absolute;
        top: 0;
        left: 0;
      }

      .annotation-canvas.drawing {
        pointer-events: all;
        cursor: crosshair;
      }

      .welcome-message {
        text-align: center;
        color: white;
        padding: 3rem;
      }

      .welcome-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.7;
      }

      .welcome-text {
        font-size: 1.2rem;
        opacity: 0.8;
        line-height: 1.6;
      }

      .loading {
        text-align: center;
        color: white;
        padding: 2rem;
        font-size: 1.1rem;
      }

      .loading::after {
        content: "";
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }

      .error-message {
        text-align: center;
        color: #ff6b6b;
        background: rgba(255, 107, 107, 0.1);
        padding: 1rem;
        border-radius: 10px;
        margin: 1rem 0;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .pages-container {
          flex-direction: column;
          gap: 1rem;
        }

        .header {
          padding: 1rem;
        }

        .controls {
          justify-content: center;
        }

        .main-content {
          padding: 1rem;
        }

        .viewer-container {
          padding: 1rem;
        }

        .annotation-controls {
          flex-wrap: wrap;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="title">üìö PDF Annotator</div>
      <div class="controls">
        <div class="file-input-wrapper">
          <input
            type="file"
            id="pdfFile"
            class="file-input"
            accept=".pdf,application/pdf"
          />
          <label for="pdfFile" class="file-label">üìÅ Choose PDF File</label>
        </div>
        <button
          id="loadSampleBtn"
          class="nav-btn"
          style="background: rgba(255, 255, 255, 0.15)"
        >
          üîÑ Test Sample
        </button>
        <div class="nav-controls">
          <button id="prevBtn" class="nav-btn" disabled>‚Üê Previous</button>
          <div id="pageInfo" class="page-info">-</div>
          <button id="nextBtn" class="nav-btn" disabled>Next ‚Üí</button>
        </div>
        <div class="zoom-controls">
          <button id="zoomOut" class="zoom-btn">‚àí</button>
          <button id="zoomIn" class="zoom-btn">+</button>
        </div>
        <div class="annotation-controls">
          <button id="penTool" class="tool-btn active" title="Pen">‚úèÔ∏è</button>
          <button id="highlightTool" class="tool-btn" title="Highlighter">
            üñçÔ∏è
          </button>
          <button id="eraserTool" class="tool-btn" title="Eraser">üßΩ</button>
          <button id="clearAll" class="tool-btn" title="Clear All">üóëÔ∏è</button>
          <div class="color-palette">
            <div
              class="color-option active"
              data-color="#000000"
              style="background: #000000"
              title="Black"
            ></div>
            <div
              class="color-option"
              data-color="#ff0000"
              style="background: #ff0000"
              title="Red"
            ></div>
            <div
              class="color-option"
              data-color="#0000ff"
              style="background: #0000ff"
              title="Blue"
            ></div>
            <div
              class="color-option"
              data-color="#00ff00"
              style="background: #00ff00"
              title="Green"
            ></div>
            <div
              class="color-option"
              data-color="#ffff00"
              style="background: #ffff00"
              title="Yellow"
            ></div>
            <div
              class="color-option"
              data-color="#ff00ff"
              style="background: #ff00ff"
              title="Magenta"
            ></div>
          </div>
          <div class="brush-size">
            <span style="color: white; font-size: 0.8rem">Size:</span>
            <input
              type="range"
              id="brushSize"
              class="size-slider"
              min="1"
              max="20"
              value="3"
            />
          </div>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="viewer-container">
        <div id="welcomeMessage" class="welcome-message">
          <div class="welcome-icon">üìñ</div>
          <div class="welcome-text">
            <strong>Get Started:</strong><br /><br />
            üìÅ <strong>Upload PDF:</strong> Click "Choose PDF File" to select
            from your device<br />
            üîÑ <strong>Test Sample:</strong> Click "Test Sample" to try the
            annotation features<br /><br />
            Use pen, highlighter, and color tools to annotate your document!
          </div>
        </div>
        <div
          id="errorMessage"
          class="error-message"
          style="display: none"
        ></div>
        <div id="loadingMessage" class="loading" style="display: none">
          Loading PDF...
        </div>
        <div
          id="pagesContainer"
          class="pages-container"
          style="display: none"
        ></div>
      </div>
    </div>

    <script>
                        // Check if PDF.js is loaded
                        if (typeof pdfjsLib === "undefined") {
                          console.error("PDF.js library not loaded");
                          document.getElementById("welcomeMessage").innerHTML =
                            '<div class="error-message">PDF.js library failed to load. Please refresh the page.</div>';
                        }

                        // Initialize PDF.js
                        pdfjsLib.GlobalWorkerOptions.workerSrc =
                          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

                        let pdfDoc = null;
                        let currentPage = 1;
                        let scale = 1.0;
                        let totalPages = 0;
                        let annotations = {}; // Store annotations per page

                        // Drawing state
                        let currentTool = "pen";
                        let currentColor = "#000000";
                        let brushSize = 3;
                        let isDrawing = false;
                        let lastX = 0;
                        let lastY = 0;

                        // Get DOM elements
                        const fileInput = document.getElementById("pdfFile");
                        const loadSampleBtn = document.getElementById("loadSampleBtn");
                        const prevBtn = document.getElementById("prevBtn");
                        const nextBtn = document.getElementById("nextBtn");
                        const pageInfo = document.getElementById("pageInfo");
                        const zoomInBtn = document.getElementById("zoomIn");
                        const zoomOutBtn = document.getElementById("zoomOut");
                        const welcomeMessage = document.getElementById("welcomeMessage");
                        const errorMessage = document.getElementById("errorMessage");
                        const loadingMessage = document.getElementById("loadingMessage");
                        const pagesContainer = document.getElementById("pagesContainer");

                        // Annotation controls
                        const penTool = document.getElementById("penTool");
                        const highlightTool = document.getElementById("highlightTool");
                        const eraserTool = document.getElementById("eraserTool");
                        const clearAllBtn = document.getElementById("clearAll");
                        const colorOptions = document.querySelectorAll(".color-option");
                        const brushSizeSlider = document.getElementById("brushSize");

                        // Event listeners
                        fileInput.addEventListener("change", handleFileSelect);
                        loadSampleBtn.addEventListener("click", loadSamplePDF);
                        prevBtn.addEventListener("click", showPrevPage);
                        nextBtn.addEventListener("click", showNextPage);
                        zoomInBtn.addEventListener("click", zoomIn);
                        zoomOutBtn.addEventListener("click", zoomOut);

                        // Annotation event listeners
                        penTool.addEventListener("click", () => setTool("pen"));
                        highlightTool.addEventListener("click", () => setTool("highlighter"));
                        eraserTool.addEventListener("click", () => setTool("eraser"));
                        clearAllBtn.addEventListener("click", clearAllAnnotations);

                        colorOptions.forEach((option) => {
                          option.addEventListener("click", () => {
                            colorOptions.forEach((c) => c.classList.remove("active"));
                            option.classList.add("active");
                            currentColor = option.dataset.color;
                          });
                        });

                        brushSizeSlider.addEventListener("input", (e) => {
                          brushSize = parseInt(e.target.value);
                        });

                        // Keyboard navigation
                        document.addEventListener("keydown", (e) => {
                          if (!pdfDoc) return;

                          switch (e.key) {
                            case "ArrowLeft":
                              e.preventDefault();
                              showPrevPage();
                              break;
                            case "ArrowRight":
                              e.preventDefault();
                              showNextPage();
                              break;
                            case "+":
                            case "=":
                              e.preventDefault();
                              zoomIn();
                              break;
                            case "-":
                              e.preventDefault();
                              zoomOut();
                              break;
                            case "p":
                              e.preventDefault();
                              setTool("pen");
                              break;
                            case "h":
                              e.preventDefault();
                              setTool("highlighter");
                              break;
                            case "e":
                              e.preventDefault();
                              setTool("eraser");
                              break;
                          }
                        });

                        function showError(message) {
                          errorMessage.textContent = message;
                          errorMessage.style.display = "block";
                          setTimeout(() => {
                            errorMessage.style.display = "none";
                          }, 5000);
                        }

                        function setTool(tool) {
                          currentTool = tool;
                          document
                            .querySelectorAll(".tool-btn")
                            .forEach((btn) => btn.classList.remove("active"));

                          switch (tool) {
                            case "pen":
                              penTool.classList.add("active");
                              break;
                            case "highlighter":
                              highlightTool.classList.add("active");
                              break;
                            case "eraser":
                              eraserTool.classList.add("active");
                              break;
                          }
                        }

                        function restoreAnnotations(ctx, pageNum) {
                          if (annotations[pageNum]) {
                            try {
                              ctx.putImageData(annotations[pageNum], 0, 0);
                            } catch (err) {
                              console.error(
                                `Failed to restore annotations for page ${pageNum}:`,
                                err
                              );
                            }
                          }
                        }

                        function updateNavigationButtons() {
                          if (!pdfDoc) {
                            prevBtn.disabled = true;
                            nextBtn.disabled = true;
                            return;
                          }

                          // Disable prev button on first page
                          prevBtn.disabled = currentPage <= 1;

                          // Disable next button if we're at the end
                          if (currentPage === 1) {
                            // First page (cover) ‚Üí enable next if more than 1 page
                            nextBtn.disabled = totalPages <= 1;
                          } else {
                            // Dual page mode ‚Üí disable next if we've reached the last page
                            nextBtn.disabled = currentPage + 1 >= totalPages;
                          }
                        }

                        function updatePageInfo() {
          if (!pdfDoc) {
              pageInfo.textContent = "-";
              return;
          }
          pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      }

                        function showPrevPage() {
                if (currentPage <= 1) return;
                currentPage -= 1;
                renderPages();
                updatePageInfo();
                updateNavigationButtons();
            }

            function showNextPage() {
                if (currentPage >= totalPages) return;
                currentPage += 1;
                renderPages();
                updatePageInfo();
                updateNavigationButtons();
            }

                        function zoomIn() {
                          scale = Math.min(scale * 1.2, 3.0);
                          if (pdfDoc) renderPages();
                        }

                        function zoomOut() {
                          scale = Math.max(scale / 1.2, 0.5);
                          if (pdfDoc) renderPages();
                        }

                        async function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) {
        showError('Please select a valid PDF file.');
        return;
    }

    showLoading();
    try {
        const arrayBuffer = await file.arrayBuffer();
        await loadPDFFromData(arrayBuffer);
    } catch (error) {
        showError('Error reading PDF file: ' + error.message);
        hideLoading();
    }
}

                        async function loadSamplePDF() {
                          console.log("Loading sample PDF...");
                          showLoading();

                          try {
                            // Create a simple sample PDF programmatically
                            const canvas = document.createElement("canvas");
                            canvas.width = 595; // A4 width in points
                            canvas.height = 842; // A4 height in points
                            const ctx = canvas.getContext("2d");

                            // Create multiple sample pages
                            const pages = [];
                            for (let i = 1; i <= 5; i++) {
                              // Clear canvas
                              ctx.fillStyle = "white";
                              ctx.fillRect(0, 0, canvas.width, canvas.height);

                              // Add some content
                              ctx.fillStyle = "black";
                              ctx.font = "32px Arial";
                              ctx.fillText(`Sample PDF - Page ${i}`, 50, 80);

                              ctx.font = "18px Arial";
                              ctx.fillText(
                                "This is a sample PDF for testing the annotation features.",
                                50,
                                150
                              );
                              ctx.fillText(
                                "Try using the pen, highlighter, and other tools!",
                                50,
                                180
                              );
                              ctx.fillText(
                                "You can draw, highlight, and take notes on this page.",
                                50,
                                210
                              );
                              ctx.fillText("Test different colors and brush sizes.", 50, 240);

                              // Add some shapes for testing
                              ctx.strokeStyle = "#333";
                              ctx.lineWidth = 2;
                              ctx.strokeRect(50, 300, 250, 120);
                              ctx.fillText("Draw inside this box", 60, 340);

                              ctx.beginPath();
                              ctx.arc(450, 360, 60, 0, 2 * Math.PI);
                              ctx.stroke();
                              ctx.fillText("Or around this circle", 380, 450);

                              // Add some text to highlight
                              ctx.fillText(
                                "Highlight this important text with the highlighter tool!",
                                50,
                                500
                              );
                              ctx.fillText(
                                "Use different colors to categorize your annotations.",
                                50,
                                530
                              );

                              pages.push(canvas.toDataURL());
                            }

                            // Simulate PDF loading
                            await new Promise((resolve) => setTimeout(resolve, 500));

                            // Create mock PDF document
                            pdfDoc = {
                              numPages: pages.length,
                              getPage: async function (pageNum) {
                                return {
                                  getViewport: function (options) {
                                    return {
                                      width: canvas.width * (options.scale || 1),
                                      height: canvas.height * (options.scale || 1),
                                    };
                                  },
                                  render: function (renderContext) {
                                    return {
                                      promise: new Promise((resolve) => {
                                        const img = new Image();
                                        img.onload = function () {
                                          renderContext.canvasContext.drawImage(
                                            img,
                                            0,
                                            0,
                                            renderContext.viewport.width,
                                            renderContext.viewport.height
                                          );
                                          resolve();
                                        };
                                        img.src = pages[pageNum - 1];
                                      }),
                                    };
                                  },
                                };
                              },
                            };

                            totalPages = pdfDoc.numPages;
                            currentPage = 1;
                            annotations = {};

                            console.log(
                              "Sample PDF created successfully. Total pages:",
                              totalPages
                            );

                            hideLoading();
                            updatePageInfo();
                            await renderPages();
                            updateNavigationButtons();
                          } catch (error) {
                            console.error("Error creating sample PDF:", error);
                            showError("Could not create sample PDF: " + error.message);
                            hideLoading();
                          }
                        }

                        async function loadPDFFromData(data) {
                          try {
                            console.log("Attempting to load PDF with PDF.js...");

                            const loadingTask = pdfjsLib.getDocument({
                              data: data,
                              cMapUrl:
                                "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/",
                              cMapPacked: true,
                              standardFontDataUrl:
                                "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/standard_fonts/",
                            });

                            pdfDoc = await loadingTask.promise;
                            totalPages = pdfDoc.numPages;
                            currentPage = 1;
                            annotations = {};

                            console.log("PDF loaded successfully. Total pages:", totalPages);

                            hideLoading();
                            updatePageInfo();
                            await renderPages();
                            updateNavigationButtons();
                          } catch (error) {
                            console.error("Error loading PDF with PDF.js:", error);
                            showError(
                              "Error loading PDF: " +
                                error.message +
                                ". Try the sample PDF instead."
                            );
                            hideLoading();
                            throw error;
                          }
                        }

                        function showLoading() {
                          welcomeMessage.style.display = "none";
                          errorMessage.style.display = "none";
                          loadingMessage.style.display = "block";
                          pagesContainer.style.display = "none";
                        }

                        function hideLoading() {
                          welcomeMessage.style.display = "none";
                          loadingMessage.style.display = "none";
                          pagesContainer.style.display = "flex";
                        }

                        async function renderPages() {
    if (!pdfDoc) {
        console.error('No PDF document loaded');
        return;
    }

    pagesContainer.innerHTML = '';

    try {
        if (currentPage <= totalPages) {
            await renderPage(currentPage, 'single');
        }
    } catch (error) {
        console.error('Error rendering page:', error);
        showError('Error rendering PDF pages: ' + error.message);
    }
}

                        async function renderPage(pageNum, position) {
                          try {
                            console.log("Rendering page:", pageNum, "position:", position);

                            const page = await pdfDoc.getPage(pageNum);
                            const viewport = page.getViewport({ scale: scale });

                            console.log("Page viewport:", viewport.width, "x", viewport.height);

                            // Create PDF canvas
                            const pdfCanvas = document.createElement("canvas");
                            const pdfContext = pdfCanvas.getContext("2d");

                            pdfCanvas.height = viewport.height;
                            pdfCanvas.width = viewport.width;
                            pdfCanvas.className = "page-canvas";

                            // Create annotation canvas
                            const annotCanvas = document.createElement("canvas");
                            const annotContext = annotCanvas.getContext("2d");

                            annotCanvas.height = viewport.height;
                            annotCanvas.width = viewport.width;
                            annotCanvas.className = "annotation-canvas drawing";
                            annotCanvas.dataset.pageNum = pageNum;

                            const wrapper = document.createElement("div");
                            wrapper.className = `page-wrapper ${
                              position === "single" ? "single-page" : ""
                            }`;
                            wrapper.style.width = viewport.width + "px";
                            wrapper.style.height = viewport.height + "px";
                            wrapper.style.position = "relative";

                            wrapper.appendChild(pdfCanvas);
                            wrapper.appendChild(annotCanvas);

                            pagesContainer.appendChild(wrapper);

                            // Render PDF
                            const renderContext = {
                              canvasContext: pdfContext,
                              viewport: viewport,
                            };

                            await page.render(renderContext).promise;
                            console.log("Page", pageNum, "rendered successfully");

                            // Restore annotations for this page
                            restoreAnnotations(annotContext, pageNum);

                            // Add drawing event listeners
                            setupDrawingEvents(annotCanvas, annotContext, pageNum);
                          } catch (error) {
                            console.error(`Error rendering page ${pageNum}:`, error);
                            showError(`Error rendering page ${pageNum}: ` + error.message);
                          }
                        }

                        function setupDrawingEvents(canvas, ctx, pageNum) {
                          let drawing = false;
                          let lastPoint = null;

                          function getMousePos(e) {
                            const rect = canvas.getBoundingClientRect();
                            return {
                              x: (e.clientX - rect.left) * (canvas.width / rect.width),
                              y: (e.clientY - rect.top) * (canvas.height / rect.height),
                            };
                          }

                          function getTouchPos(e) {
                            const rect = canvas.getBoundingClientRect();
                            const touch = e.touches[0];
                            return {
                              x: (touch.clientX - rect.left) * (canvas.width / rect.width),
                              y: (touch.clientY - rect.top) * (canvas.height / rect.height),
                            };
                          }

                          function configureDrawingContext() {
                            ctx.lineCap = "round";
                            ctx.lineJoin = "round";

                            if (currentTool === "pen") {
                              ctx.globalCompositeOperation = "source-over";
                              ctx.strokeStyle = currentColor;
                              ctx.globalAlpha = 1.0;
                              ctx.lineWidth = brushSize;
                            } else if (currentTool === "highlighter") {
                              ctx.globalCompositeOperation = "source-over";
                              ctx.strokeStyle = currentColor;
                              ctx.globalAlpha = 0.3;
                              ctx.lineWidth = brushSize * 4;
                            } else if (currentTool === "eraser") {
                              ctx.globalCompositeOperation = "destination-out";
                              ctx.globalAlpha = 1.0;
                              ctx.lineWidth = brushSize * 3;
                            }
                          }

                          function startDrawing(pos) {
                            drawing = true;
                            lastPoint = pos;
                            configureDrawingContext();

                            ctx.beginPath();
                            ctx.moveTo(pos.x, pos.y);

                            // Draw a dot for single clicks
                            ctx.arc(pos.x, pos.y, ctx.lineWidth / 2, 0, 2 * Math.PI);
                            ctx.fill();
                            ctx.beginPath();
                            ctx.moveTo(pos.x, pos.y);
                          }

                          function draw(pos) {
                            if (!drawing || !lastPoint) return;

                            configureDrawingContext();

                            ctx.beginPath();
                            ctx.moveTo(lastPoint.x, lastPoint.y);
                            ctx.lineTo(pos.x, pos.y);
                            ctx.stroke();

                            lastPoint = pos;
                          }

                          function stopDrawing() {
                            if (!drawing) return;
                            drawing = false;
                            lastPoint = null;

                            // Save annotation data
                            try {
                              const imageData = ctx.getImageData(
                                0,
                                0,
                                canvas.width,
                                canvas.height
                              );
                              annotations[pageNum] = imageData;
                            } catch (err) {
                              console.error(
                                `Failed to save annotations for page ${pageNum}:`,
                                err
                              );
                            }
                          }

                          // Mouse events
                          canvas.addEventListener("mousedown", (e) => {
                            e.preventDefault();
                            startDrawing(getMousePos(e));
                          });

                          canvas.addEventListener("mousemove", (e) => {
                            e.preventDefault();
                            if (drawing) {
                              draw(getMousePos(e));
                            }
                          });

                          canvas.addEventListener("mouseup", (e) => {
                            e.preventDefault();
                            stopDrawing();
                          });

                          canvas.addEventListener("mouseout", (e) => {
                            stopDrawing();
                          });

                          // Touch events
                          canvas.addEventListener("touchstart", (e) => {
                            e.preventDefault();
                            startDrawing(getTouchPos(e));
                          });

                          canvas.addEventListener("touchmove", (e) => {
                            e.preventDefault();
                            if (drawing) {
                              draw(getTouchPos(e));
                            }
                          });

                          canvas.addEventListener("touchend", (e) => {
                            e.preventDefault();
                            stopDrawing();
                          });

                          canvas.addEventListener("touchcancel", (e) => {
                            e.preventDefault();
                            stopDrawing();
                          });
                        }

                        function clearAllAnnotations() {
                          if (
                            confirm(
                              "Are you sure you want to clear all annotations? This action cannot be undone."
                            )
                          ) {
                            annotations = {};
                            document.querySelectorAll(".annotation-canvas").forEach((canvas) => {
                              const ctx = canvas.getContext("2d");
                              ctx.clearRect(0, 0, canvas.width, canvas.height);
                            });
                          }
                        }
    </script>
  </body>
</html>
